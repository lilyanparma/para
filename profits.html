<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>فاتورة شهرية</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-app.js "></script>
  <script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-database.js "></script>

  <!-- html2pdf.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js "></script>

  <style>
    /* إعدادات عامة */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      width: 100%;
      height: 100%;
      overflow-x: hidden;
      font-family: 'Tahoma', 'DejaVu Sans', 'Arial', sans-serif;
      background-color: #f4f4f4;
      direction: rtl;
    }

    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 30px 10px;
    }

    .container {
      width: 100%;
      max-width: 600px;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
      text-align: center;
    }

    h1 {
      font-size: 24px;
      color: #333;
      margin-bottom: 10px;
    }

    p {
      font-size: 16px;
      color: #555;
      margin-bottom: 20px;
    }

    button {
      padding: 12px 24px;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      background-color: #007BFF;
      color: white;
      transition: background-color 0.3s ease;
    }

    button:hover {
      background-color: #0056b3;
    }

    /* تصميم الفاتورة - غير مرئية حتى التوليد */
    #invoiceContent {
      visibility: hidden;
      position: absolute;
      left: -9999px;
      width: 100%;
      max-width: 800px;
      margin: auto;
      padding: 30px;
      background: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      font-size: 14px;
      line-height: 1.6;
    }

    .header {
      text-align: center;
      margin-bottom: 20px;
    }

    .company-name {
      font-size: 24px;
      font-weight: bold;
      color: #007BFF;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      vertical-align: top;
    }

    th {
      background-color: #007BFF;
      color: white;
    }

    tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    .total-row td {
      font-weight: bold;
      background-color: #e9ecef;
    }

    .footer {
      margin-top: 30px;
      font-style: italic;
      color: #555;
    }
  </style>
</head>
<body>

  <div class="container">
    <h1>إنشاء فاتورة شهرية</h1>
    <p>انقر على الزر أدناه لإنشاء فاتورة شهرية تلقائية بصيغة PDF.</p>
    <button onclick="generateInvoice()">إنشاء فاتورة (PDF)</button>
  </div>

  <!-- نموذج الفاتورة -->
  <div id="invoiceContent">
    <div class="header">
      <div class="company-name">صيدلية المستقبل</div>
      <h2>فاتورة شهرية</h2>
      <p><strong>الشهر:</strong> <span id="arMonth"></span></p>
      <p><strong>تاريخ الإصدار:</strong> <span id="todayDate"></span></p>
    </div>

    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>المنتج</th>
          <th style="width: 100px;">الكمية</th>
          <th style="width: 100px;">السعر</th>
          <th style="width: 100px;">الإجمالي</th>
        </tr>
      </thead>
      <tbody id="productsTableBody"></tbody>
    </table>

    <table style="margin-top: 20px;">
      <tbody>
        <tr class="total-row">
          <td colspan="3"><strong>إجمالي المبيعات</strong></td>
          <td colspan="2"><span dir="ltr" id="totalSales"></span> ريال</td>
        </tr>
        <tr class="total-row">
          <td colspan="3"><strong>إجمالي المصاريف</strong></td>
          <td colspan="2"><span dir="ltr" id="totalExpenses"></span> ريال</td>
        </tr>
        <tr class="total-row">
          <td colspan="3"><strong>الأرباح</strong></td>
          <td colspan="2"><span dir="ltr" id="profit"></span> ريال</td>
        </tr>
      </tbody>
    </table>

    <div class="footer">
      شكرًا لتعاملكم مع صيدلية المستقبل. إذا كانت لديك أي استفسارات، يرجى التواصل معنا.
    </div>
  </div>

  <script>
    // إعداد Firebase - استبدل هذه القيم ببيانات مشروعك
   // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyDRtJBPOjpfXXfsaDo98E_NTT7KWzz8gj4",
  authDomain: "pharmacy-system-9def6.firebaseapp.com",
  databaseURL: "https://pharmacy-system-9def6-default-rtdb.firebaseio.com",
  projectId: "pharmacy-system-9def6",
  storageBucket: "pharmacy-system-9def6.firebasestorage.app",
  messagingSenderId: "630855008414",
  appId: "1:630855008414:web:b464bcb81c8a2091d0fb8f",
  measurementId: "G-LC5NDKP6QZ"
};

    // تهيئة Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    async function generateInvoice() {
      const now = new Date();
      const month = now.toISOString().slice(0, 7); // مثل: "2025-04"

      try {
        // جلب المنتجات
        const productsSnapshot = await database.ref("products").once("value");
        let totalSales = 0;
        let soldProducts = [];

        productsSnapshot.forEach(childSnap => {
          const product = childSnap.val();
          const soldCount = product.maxQuantity - product.quantity;

          if (soldCount > 0) {
            const salesAmount = soldCount * product.price;
            totalSales += salesAmount;

            soldProducts.push({
              name: product.name,
              quantity: soldCount,
              price: product.price,
              amount: salesAmount
            });
          }
        });

        if (soldProducts.length === 0) {
          alert("لم يتم بيع أي منتجات خلال هذا الشهر.");
          return;
        }

        // جلب المصاريف
        const expensesSnapshot = await database.ref("expenses/" + month).once("value");
        const expensesData = expensesSnapshot.val() || {};
        const totalExpenses = parseFloat(expensesData.amount) || 0;
        const profit = totalSales - totalExpenses;

        // تحويل التاريخ إلى عربي
        const monthsAr = [
          "يناير", "فبراير", "مارس", "أبريل", "مايو", "يونيو",
          "يوليو", "أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر"
        ];
        const arMonth = `${monthsAr[now.getMonth()]} ${now.getFullYear()}`;
        const today = new Date().toLocaleDateString("ar-EG");

        // تحديث محتوى الفاتورة
        document.getElementById("arMonth").innerText = arMonth;
        document.getElementById("todayDate").innerText = today;
        document.getElementById("totalSales").innerHTML = `<span dir="ltr">${totalSales.toFixed(2)}</span>`;
        document.getElementById("totalExpenses").innerHTML = `<span dir="ltr">${totalExpenses.toFixed(2)}</span>`;
        document.getElementById("profit").innerHTML = `<span dir="ltr">${profit.toFixed(2)}</span>`;

        const tbody = document.getElementById("productsTableBody");
        tbody.innerHTML = "";
        soldProducts.forEach((item, index) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${index + 1}</td>
            <td>${item.name}</td>
            <td><span dir="ltr">${item.quantity}</span></td>
            <td><span dir="ltr">${item.price.toFixed(2)}</span></td>
            <td><span dir="ltr">${item.amount.toFixed(2)}</span></td>
          `;
          tbody.appendChild(row);
        });

        // إظهار الفاتورة مؤقتًا لإنشاء PDF
        const element = document.getElementById("invoiceContent");
        element.style.visibility = 'visible';
        element.style.position = 'static';

        // تحويل HTML إلى PDF
        const opt = {
          margin:       1,
          filename:     `فاتورة_${arMonth}.pdf`,
          image:        { type: 'jpeg', quality: 0.98 },
          html2canvas:  { scale: 2 },
          jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
        };

        await html2pdf().set(opt).from(element).save();

        // إعادة إخفاء الفاتورة بعد الانتهاء
        element.style.visibility = 'hidden';
        element.style.position = 'absolute';
        element.style.left = '-9999px';

      } catch (error) {
        alert("حدث خطأ أثناء جلب البيانات: " + error.message);
      }
    }
  </script>
</body>
</html>
